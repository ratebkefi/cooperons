<?php

namespace Apr\ProgramBundle\Repository;

use Doctrine\ORM\EntityRepository;

/**
 * OperationCreditRepository
 *
 * This class was generated by the Doctrine ORM. Add your own custom
 * repository methods below.
 */
class OperationCreditRepository extends EntityRepository
{

    /**
     * Create query find users for ajax grid, return users
     * @param array $params search parameters for grid 
     * @return Array.
     */
    public function searchOperation($search = NULL, $program=NULL) {
        //Begin build query 
        $query = $this->createQueryBuilder('o');
        $query->leftJoin('o.program','p');
        if($program){
            $query->where('o.program =  :program');
        }else{
            $query->where('o.id IS NOT NULL');
        }
        if (is_string($search) && !empty($search)) {
            $query->andwhere($query->expr()->like('lower(o.label)', '?1'));
            $query->orWhere($query->expr()->like('lower(o.description)', '?1'));
            $query->orWhere($query->expr()->like('lower(p.label)', '?1'));
            $query->orWhere($query->expr()->like('lower(p.description)', '?1'));
            $query->setParameter('1', '%' . strtolower($search) . '%');
        }
        if($program){
            $query->setParameter('program', $program);
        }
        // Get result
        return $query->getQuery()->getResult();
    }

}

?>
